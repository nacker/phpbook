# 文件上传

## 1. php 关于文件上传的配置

> 文件上传项目项在`php.ini`中设置,常用的配置项有:

| 序号 | 配置项                | 默认值 | 描述                                          |
| ---- | --------------------- | ------ | --------------------------------------------- |
| 1    | `file_uploads`        | `On`   | 使 PHP 支持文件上传                           |
| 2    | `upload_tmp_dir`      | `/tmp` | 设置上传文件的暂存区位置        |
| 3    | `max_file_uploads`    | `20`   | 单次请求时允许上传的最大文件数量              |
| 4    | `max_execution_time`  | `30`   | 设置脚本被解析器终止之前PHP最长执行时间(秒) ,防止服务器资源被耗尽                    |
| 5    | `max_input_time`      | `60`   | 设置 PHP 通过 POST/GET/PUT 解析接收数据的时长(秒) |
| 6    | `memory_limit`        | `128M` | 设置脚本能够分配的最大内存容量 单位字节 1M等于1024K，一兆等于1048576字节     |
| 7    | `post_max_size`       | `8M`   | 设置通过 POST方法提交的数据量上限       |
| 8    | `upload_max_filesize` | `2M`  | 设置上传的单个文件的数据量上限    |
`memory_limit >= post_max_size  防止失控的脚本独占服务器内存，严重时使服务器崩溃`
`post_max_size > upload_max_filesize  因为后者只是限制通过file输入类型传递过来的数据量，不像post_max_size可以限制所有通过post方法上传的数据量上限`

## 2. `$_FILE`

- 上传文件的描述信息,全部保存在系统全局变量`$_FILES`中
- `$_FILES`以二维数组形式保存: `$_FILES['form_file_name']['key']`
- `'form_file_name'`: 对应着表单中`<input type="file" name="my_pic">`中`name`属性值
- `'key'`: 共有 5 个键名, 描述如下:

| 序号 | 键名       | 描述                                               |
| ---- | ---------- | -------------------------------------------------- |
| 1    | `name`     | 文件在客户端的原始文件名(即存在用户电脑上的文件名) |
| 2    | `type`     | 文件的 MIME 类型, 由浏览器提供, PHP 并不检查它     |
| 3    | `tmp_name` | 文件被上传到服务器上之后,在临时目录中显示的临时文件名    |
| 4    | `error`    | 和该文件上传相关的错误代码                         |
| 5    | `size`     | 已上传文件在客户端机器上的实际大小(单位为字节)                       |

- 文件上传错误信息描述

| 序号 | 常量                    | 值  | 描述                                       |
| ---- | ----------------------- | --- | ------------------------------------------ |
| 1    | `UPLOAD_ERR_OK`         | `0` | 没有错误发生,文件上传成功                  |
| 2    | `UPLOAD_ERR_INI_SIZE`   | `1` | 文件超过`php.ini`中`upload_max_filesize`值 |
| 3    | `UPLOAD_ERR_FORM_SIZE`  | `2` | 文件大小超过表单中`MAX_FILE_SIZE`指定的值  |
| 4    | `UPLOAD_ERR_PARTIAL`    | `3` | 文件只有部分被上传                         |
| 5    | `UPLOAD_ERR_NO_FILE`    | `4` | 没有文件被上传                             |
| 6    | `UPLOAD_ERR_NO_TMP_DIR` | `6` | 找不到临时文件夹                           |
| 7    | `UPLOAD_ERR_CANT_WRITE` | `7` | 文件写入失败                               |

## 3. `PHP文件上传函数`

- `系统中提供了多个文件处理函数，php还提供了两个专门来处理文件上传功能的函数`

| 序号 | 键名       | 描述                                               |
| ---- | ---------- | -------------------------------------------------- |
| 1    | `is_uploaded_file()`   | 用来检测文件是否是通过http post方法上传的，而不是系统上的一个文件。作用是防止潜在攻击者通过问题脚本访问并非用于交互的文件|
| 2    | `move_uploaded_file()` | 将上传的文件从临时目录移动到最终位置|
